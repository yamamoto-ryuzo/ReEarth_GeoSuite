(function(){
  try {
    const targetId = '01kbst105teyg4c2dsfqvdyk7t';
    const viewerProp = (reearth.viewer && reearth.viewer.property) ? reearth.viewer.property : (reearth.viewer && typeof reearth.viewer.getViewerProperty === 'function' ? reearth.viewer.getViewerProperty() : null);
    console.log('viewerProp (before):', viewerProp && viewerProp.tiles);
    if (!viewerProp || !Array.isArray(viewerProp.tiles)) {
      console.error('No tiles found to modify.');
      return;
    }
    const newTiles = viewerProp.tiles.map((t, i) => {
      const id = t && (t.id || t.name || t.tileId) ? (t.id || t.name || t.tileId) : (t.url || `tile-${i}`);
      const base = Object.assign({}, t);
      if (id === targetId || base.url === targetId || String(i) === String(targetId)) {
        // Toggle opacity: if currently 0 -> set to 1, otherwise set to 0
        const currentOpacity = (typeof base.opacity === 'number') ? base.opacity : 1;
        base.opacity = (currentOpacity === 0) ? 1 : 0;
        console.log('Toggling opacity for', id, 'from', currentOpacity, 'to', base.opacity, base);
      } else {
        if (typeof base.opacity !== 'number') base.opacity = 1;
      }
      return base;
    });
    try {
      console.log('Calling reearth.viewer.overrideProperty with newTiles', newTiles);
      reearth.viewer.overrideProperty({ tiles: newTiles });
      console.log('overrideProperty called');
    } catch(e) {
      console.error('overrideProperty threw', e);
    }
    // read back after short delay
    setTimeout(function(){
      try {
        const after = (reearth.viewer && typeof reearth.viewer.getViewerProperty === 'function') ? reearth.viewer.getViewerProperty() : (reearth.viewer && reearth.viewer.property);
        console.log('viewerProp (after):', after && after.tiles);
      } catch(e){ console.error('readback error', e); }
    }, 300);
  } catch(e) {
    console.error('test script error', e);
  }
})();